<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚ç…§ç‰‡å±•ç¤º</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #displayImage {
            max-height: 500px;
            width: auto;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #photo-container {
            position: relative;
        }
    </style>
</head>
<body class="bg-dark text-white">

<div class="container mt-5">
    <h1 class="text-center mb-4">å³æ™‚ç…§ç‰‡å±•ç¤º</h1>
    <div id="photo-container" class="text-center">
        <img id="displayImage" src="" class="img-fluid rounded shadow">
        <h3 id="username" class="mt-3"></h3>
        <p id="message"></p>
        <small id="timestamp" class="text-muted"></small>
    </div>
</div>

<script>
const socket = io("http://localhost:2000/slideshow", {
    transports: ['websocket']
});

let playlist = [];    // ä¸»è¼ªæ’­æ¸…å–®ï¼ˆèˆŠç…§ç‰‡ï¼‰
let newQueue = [];    // æ’æ’­æ¸…å–®ï¼ˆæ–°ç…§ç‰‡ï¼‰
let currentIndex = 0; // playlist æ’­æ”¾ä½ç½®

// æ¥æ”¶åˆ°å¾Œç«¯æ¨é€çš„æ–°ç…§ç‰‡
socket.on('new_photo', (photo) => {
    console.log("ğŸ“¸ æ”¶åˆ°æ–°ç…§ç‰‡ï¼š", photo);
    newQueue.push(photo);
});

// é¡¯ç¤ºç…§ç‰‡ï¼Œæ·¡å…¥æ•ˆæœ
function displayPhoto(photo) {
    const img = document.getElementById('displayImage');
    img.style.opacity = 0; // å…ˆéš±è—
    setTimeout(() => {
        img.src = photo.image_url;
        document.getElementById('username').textContent = photo.username;
        document.getElementById('message').textContent = photo.message;
        document.getElementById('timestamp').textContent = new Date(photo.uploaded_at).toLocaleString();
        img.style.opacity = 1; // æ·¡å…¥
    }, 500); // 0.5ç§’å¾Œæ›åœ–
}

// æ’­æ”¾é‚è¼¯
function startSlideshow() {
    setInterval(() => {
        let nextPhoto = null;

        if (newQueue.length > 0) {
            // å„ªå…ˆæ’­æ”¾æ–°ç…§ç‰‡
            nextPhoto = newQueue.shift();
            playlist.push(nextPhoto); // æ’­å®Œå¾ŒåŠ å…¥ playlist
        } else if (playlist.length > 0) {
            nextPhoto = playlist[currentIndex];
            currentIndex = (currentIndex + 1) % playlist.length;
        }

        if (nextPhoto) displayPhoto(nextPhoto);

    }, 5000); // æ¯ 5 ç§’æ›ä¸€å¼µ
}

// å•Ÿå‹•è¼ªæ’­
startSlideshow();
</script>

</body>
</html>