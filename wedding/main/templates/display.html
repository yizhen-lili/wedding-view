<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時照片展示</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #displayImage {
            max-height: 500px;
            width: auto;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #photo-container {
            position: relative;
        }
    </style>
</head>
<body class="bg-dark text-white">

<div class="container mt-5">
    <h1 class="text-center mb-4">即時照片展示</h1>
    <div id="photo-container" class="text-center">
        <img id="displayImage" src="" class="img-fluid rounded shadow">
        <h3 id="username" class="mt-3"></h3>
        <p id="message"></p>
        <small id="timestamp" class="text-muted"></small>
    </div>
</div>

<script>
const socket = io("http://localhost:2000/slideshow", {
    transports: ['websocket']
});

let playlist = [];    // 主輪播清單（舊照片）
let newQueue = [];    // 插播清單（新照片）
let currentIndex = 0; // playlist 播放位置

// 接收到後端推送的新照片
socket.on('new_photo', (photo) => {
    console.log("📸 收到新照片：", photo);
    newQueue.push(photo);
});

// 顯示照片，淡入效果
function displayPhoto(photo) {
    const img = document.getElementById('displayImage');
    img.style.opacity = 0; // 先隱藏
    setTimeout(() => {
        img.src = photo.image_url;
        document.getElementById('username').textContent = photo.username;
        document.getElementById('message').textContent = photo.message;
        document.getElementById('timestamp').textContent = new Date(photo.uploaded_at).toLocaleString();
        img.style.opacity = 1; // 淡入
    }, 500); // 0.5秒後換圖
}

// 播放邏輯
function startSlideshow() {
    setInterval(() => {
        let nextPhoto = null;

        if (newQueue.length > 0) {
            // 優先播放新照片
            nextPhoto = newQueue.shift();
            playlist.push(nextPhoto); // 播完後加入 playlist
        } else if (playlist.length > 0) {
            nextPhoto = playlist[currentIndex];
            currentIndex = (currentIndex + 1) % playlist.length;
        }

        if (nextPhoto) displayPhoto(nextPhoto);

    }, 5000); // 每 5 秒換一張
}

// 啟動輪播
startSlideshow();
</script>

</body>
</html>